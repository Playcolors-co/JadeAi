<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- System Status -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">System Status</h5>
                    <button class="btn btn-secondary btn-sm" onclick="refreshStatus()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div class="system-stats" id="system-stats">
                        <!-- System stats will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- Services -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">System Services</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Service</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="services-list">
                                <!-- Services will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- System Logs -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">System Logs</h5>
                    <button class="btn btn-secondary btn-sm" onclick="refreshLogs()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div class="logs-container" style="max-height: 400px; overflow-y: auto;">
                        <pre id="system-logs" class="small text-muted"></pre>
                    </div>
                </div>
            </div>
            
            <!-- System Maintenance -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">System Maintenance</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6>System Updates</h6>
                                    <p class="small text-muted">Update system packages and software</p>
                                    <button class="btn btn-primary" onclick="updateSystem()">
                                        <i class="bi bi-cloud-download"></i> Check for Updates
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6>Backup & Restore</h6>
                                    <p class="small text-muted">Manage system backups</p>
                                    <div class="btn-group">
                                        <button class="btn btn-primary" onclick="createBackup()">
                                            <i class="bi bi-save"></i> Create Backup
                                        </button>
                                        <button class="btn btn-secondary" onclick="showRestoreModal()">
                                            <i class="bi bi-arrow-counterclockwise"></i> Restore
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6>Power Options</h6>
                                    <p class="small text-muted">System power management</p>
                                    <div class="btn-group">
                                        <button class="btn btn-warning" onclick="confirmReboot()">
                                            <i class="bi bi-arrow-repeat"></i> Reboot
                                        </button>
                                        <button class="btn btn-danger" onclick="confirmShutdown()">
                                            <i class="bi bi-power"></i> Shutdown
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Restore Backup Modal -->
<div class="modal fade" id="restoreModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Restore from Backup</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Select Backup</label>
                    <select id="backup-select" class="form-select">
                        <!-- Backups will be populated here -->
                    </select>
                </div>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    Warning: Restoring from backup will overwrite current settings.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="restoreBackup()">Restore</button>
            </div>
        </div>
    </div>
</div>

<script>
let restoreModal;
let statusInterval;

function initSystem() {
    restoreModal = new bootstrap.Modal(document.getElementById('restoreModal'));
    refreshStatus();
    refreshServices();
    refreshLogs();
    
    // Refresh status periodically
    statusInterval = setInterval(refreshStatus, 5000);
}

function refreshStatus() {
    fetch('/api/system/info')
        .then(response => response.json())
        .then(info => {
            const statsDiv = document.getElementById('system-stats');
            statsDiv.innerHTML = `
                <div class="stat-card">
                    <div class="stat-title">CPU Usage</div>
                    <div class="stat-value">${info.cpu.usage_percent}%</div>
                    <div class="small text-muted">Temperature: ${info.cpu.temperature}Â°C</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Memory</div>
                    <div class="stat-value">${Math.round(info.memory.percent)}%</div>
                    <div class="small text-muted">${formatBytes(info.memory.used)} / ${formatBytes(info.memory.total)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Disk Usage</div>
                    <div class="stat-value">${Math.round(info.disk.percent)}%</div>
                    <div class="small text-muted">${formatBytes(info.disk.used)} / ${formatBytes(info.disk.total)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Uptime</div>
                    <div class="stat-value">${formatUptime(info.uptime)}</div>
                </div>
            `;
        })
        .catch(error => console.error('Failed to refresh status'));
}

function refreshServices() {
    fetch('/api/system/services')
        .then(response => response.json())
        .then(services => {
            const tbody = document.getElementById('services-list');
            tbody.innerHTML = '';
            
            Object.entries(services).forEach(([service, status]) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${service}</td>
                    <td>
                        <span class="badge ${status === 'active' ? 'bg-success' : 'bg-danger'}">
                            ${status}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="controlService('${service}', 'start')" ${status === 'active' ? 'disabled' : ''}>
                                Start
                            </button>
                            <button class="btn btn-outline-warning" onclick="controlService('${service}', 'restart')">
                                Restart
                            </button>
                            <button class="btn btn-outline-danger" onclick="controlService('${service}', 'stop')" ${status !== 'active' ? 'disabled' : ''}>
                                Stop
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        })
        .catch(error => showError('Failed to get services'));
}

function refreshLogs() {
    fetch('/api/system/logs')
        .then(response => response.json())
        .then(data => {
            const logsDiv = document.getElementById('system-logs');
            logsDiv.textContent = data.logs.join('\n');
            logsDiv.scrollTop = logsDiv.scrollHeight;
        })
        .catch(error => showError('Failed to get logs'));
}

function controlService(service, action) {
    fetch('/api/system/service/control', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ service, action })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(`Service ${action} successful`);
            setTimeout(refreshServices, 1000);
        } else {
            showError(data.error || 'Failed to control service');
        }
    })
    .catch(error => showError('Failed to control service'));
}

function updateSystem() {
    if (confirm('Update system packages? This may take several minutes.')) {
        fetch('/api/system/update', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess('System update complete');
                } else {
                    showError(data.error || 'Update failed');
                }
            })
            .catch(error => showError('Update failed'));
    }
}

function createBackup() {
    fetch('/api/system/backup', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('Backup created successfully');
            } else {
                showError(data.error || 'Failed to create backup');
            }
        })
        .catch(error => showError('Failed to create backup'));
}

function showRestoreModal() {
    // Get available backups
    fetch('/api/system/backups')
        .then(response => response.json())
        .then(backups => {
            const select = document.getElementById('backup-select');
            select.innerHTML = '';
            
            backups.forEach(backup => {
                const option = document.createElement('option');
                option.value = backup.file;
                option.textContent = backup.timestamp;
                select.appendChild(option);
            });
            
            if (backups.length > 0) {
                restoreModal.show();
            } else {
                showError('No backups available');
            }
        })
        .catch(error => showError('Failed to get backups'));
}

function restoreBackup() {
    const file = document.getElementById('backup-select').value;
    if (!file) return;
    
    if (confirm('Are you sure you want to restore from this backup? Current settings will be lost.')) {
        fetch('/api/system/restore', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ file })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('Restore complete. System will reboot.');
                restoreModal.hide();
                setTimeout(() => window.location.reload(), 5000);
            } else {
                showError(data.error || 'Restore failed');
            }
        })
        .catch(error => showError('Restore failed'));
    }
}

function confirmReboot() {
    if (confirm('Are you sure you want to reboot the system?')) {
        fetch('/api/system/reboot', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess('System is rebooting...');
                    setTimeout(() => window.location.reload(), 30000);
                } else {
                    showError(data.error || 'Reboot failed');
                }
            })
            .catch(error => showError('Reboot failed'));
    }
}

function confirmShutdown() {
    if (confirm('Are you sure you want to shut down the system?')) {
        fetch('/api/system/shutdown', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess('System is shutting down...');
                } else {
                    showError(data.error || 'Shutdown failed');
                }
            })
            .catch(error => showError('Shutdown failed'));
    }
}

function formatBytes(bytes) {
    const units = ['B', 'KB', 'MB', 'GB', 'TB'];
    let size = bytes;
    let unit = 0;
    
    while (size >= 1024 && unit < units.length - 1) {
        size /= 1024;
        unit++;
    }
    
    return `${size.toFixed(1)} ${units[unit]}`;
}

function formatUptime(seconds) {
    const days = Math.floor(seconds / 86400);
    const hours = Math.floor((seconds % 86400) / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    
    const parts = [];
    if (days > 0) parts.push(`${days}d`);
    if (hours > 0) parts.push(`${hours}h`);
    if (minutes > 0) parts.push(`${minutes}m`);
    
    return parts.join(' ') || '< 1m';
}

// Clean up when leaving the section
function cleanupSystem() {
    clearInterval(statusInterval);
}
</script>
