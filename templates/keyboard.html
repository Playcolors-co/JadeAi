<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Jade AI HID</h5>
                    <button class="btn btn-primary" onclick="setupDevice()">
                        <i class="bi bi-keyboard"></i> Setup HID Device
                    </button>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <h6>Connected Devices</h6>
                        <ul id="keyboard-devices" class="device-list">
                            <!-- Devices will be populated here -->
                        </ul>
                    </div>
                    
                    <div class="mb-4">
                        <h6>Keyboard Control</h6>
                        <div class="input-group mb-3">
                            <textarea id="keyboard-text" class="form-control" rows="3" placeholder="Enter text to send..."></textarea>
                            <button class="btn btn-primary" onclick="sendText()">
                                <i class="bi bi-send"></i> Send
                            </button>
                        </div>
                        <div class="mb-3">
                            <h6>Keyboard Quick Actions</h6>
                            <div class="btn-group">
                                <button class="btn btn-outline-secondary" onclick="sendSpecialKey('enter')">
                                    <i class="bi bi-arrow-return-left"></i> Enter
                                </button>
                                <button class="btn btn-outline-secondary" onclick="sendSpecialKey('tab')">
                                    <i class="bi bi-arrow-right-square"></i> Tab
                                </button>
                                <button class="btn btn-outline-secondary" onclick="sendSpecialKey('escape')">
                                    <i class="bi bi-x-square"></i> Esc
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h6>Mouse Control</h6>
                        <div class="mb-3">
                            <div class="btn-group">
                                <button class="btn btn-outline-secondary" onclick="sendMouseButton('left')">
                                    <i class="bi bi-mouse"></i> Left Click
                                </button>
                                <button class="btn btn-outline-secondary" onclick="sendMouseButton('right')">
                                    <i class="bi bi-mouse"></i> Right Click
                                </button>
                                <button class="btn btn-outline-secondary" onclick="sendMouseButton('middle')">
                                    <i class="bi bi-mouse"></i> Middle Click
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <h6>Mouse Movement</h6>
                            <div class="d-flex justify-content-center mb-2">
                                <button class="btn btn-outline-secondary" onclick="moveMouseRelative(0, -10)">
                                    <i class="bi bi-arrow-up"></i>
                                </button>
                            </div>
                            <div class="d-flex justify-content-center mb-2">
                                <button class="btn btn-outline-secondary me-2" onclick="moveMouseRelative(-10, 0)">
                                    <i class="bi bi-arrow-left"></i>
                                </button>
                                <button class="btn btn-outline-secondary ms-2" onclick="moveMouseRelative(10, 0)">
                                    <i class="bi bi-arrow-right"></i>
                                </button>
                            </div>
                            <div class="d-flex justify-content-center">
                                <button class="btn btn-outline-secondary" onclick="moveMouseRelative(0, 10)">
                                    <i class="bi bi-arrow-down"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <h6>Mouse Scroll</h6>
                            <div class="btn-group">
                                <button class="btn btn-outline-secondary" onclick="scrollMouse(1)">
                                    <i class="bi bi-arrow-up-circle"></i> Scroll Up
                                </button>
                                <button class="btn btn-outline-secondary" onclick="scrollMouse(-1)">
                                    <i class="bi bi-arrow-down-circle"></i> Scroll Down
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Device Status</h5>
                </div>
                <div class="card-body">
                    <div id="keyboard-status">
                        <!-- Status will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function initKeyboard() {
    // Get device status
    fetch('/api/hid/status')
        .then(response => response.json())
        .then(data => {
            updateKeyboardStatus(data);
        })
        .catch(error => showError('Failed to get device status'));
        
    // Get connected devices
    refreshKeyboardDevices();
}

function refreshKeyboardDevices() {
    fetch('/api/bluetooth/devices/paired')
        .then(response => response.json())
        .then(devices => {
            const deviceList = document.getElementById('keyboard-devices');
            deviceList.innerHTML = '';
            
            devices.forEach(device => {
                const li = document.createElement('li');
                li.className = 'device-item';
                
                // Add device type icon
                let typeIcon = 'keyboard';
                let typeText = 'Keyboard';
                if (device.type === 'mouse') {
                    typeIcon = 'mouse';
                    typeText = 'Mouse';
                } else if (device.type === 'combo') {
                    typeIcon = 'keyboard-fill';
                    typeText = 'Jade AI HID';
                }
                
                li.innerHTML = `
                    <div class="device-info">
                        <div class="device-name">
                            <i class="bi bi-${typeIcon} me-2"></i>
                            ${device.name}
                            <span class="badge bg-secondary ms-2">${typeText}</span>
                        </div>
                        <div class="device-mac">${device.mac}</div>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="unpairDevice('${device.mac}')">
                        <i class="bi bi-trash"></i>
                    </button>
                `;
                deviceList.appendChild(li);
            });
            
            if (devices.length === 0) {
                deviceList.innerHTML = '<div class="text-muted">No devices connected</div>';
            }
        })
        .catch(error => showError('Failed to get devices'));
}

function setupDevice() {
    fetch('/api/hid/setup', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('Device setup complete');
            initKeyboard();
        } else {
            showError(data.error || 'Failed to setup device');
        }
    })
    .catch(error => showError('Failed to setup device'));
}

function sendText() {
    const text = document.getElementById('keyboard-text').value;
    if (!text) {
        showError('Please enter text to send');
        return;
    }
    
    fetch('/api/hid/keyboard/send', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ text })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('Text sent successfully');
            document.getElementById('keyboard-text').value = '';
        } else {
            showError(data.error || 'Failed to send text');
        }
    })
    .catch(error => showError('Failed to send text'));
}

function sendSpecialKey(key) {
    fetch('/api/hid/keyboard/type', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ key })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            showError(data.error || 'Failed to send key');
        }
    })
    .catch(error => showError('Failed to send key'));
}

function sendMouseButton(button) {
    fetch('/api/hid/mouse/click', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ button })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            showError(data.error || 'Failed to send mouse click');
        }
    })
    .catch(error => showError('Failed to send mouse click'));
}

function moveMouseRelative(x, y) {
    fetch('/api/hid/mouse/move', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ x, y, relative: true })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            showError(data.error || 'Failed to move mouse');
        }
    })
    .catch(error => showError('Failed to move mouse'));
}

function scrollMouse(amount) {
    fetch('/api/hid/mouse/scroll', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ amount })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            showError(data.error || 'Failed to scroll');
        }
    })
    .catch(error => showError('Failed to scroll'));
}

function updateKeyboardStatus(status) {
    const statusDiv = document.getElementById('keyboard-status');
    statusDiv.innerHTML = `
        <div class="network-status">
            <div class="status-indicator ${status.device_exists ? 'status-active' : 'status-inactive'}"></div>
            <span>Device Status: ${status.device_exists ? 'Ready' : 'Not Configured'}</span>
        </div>
        <div class="network-status">
            <div class="status-indicator ${status.device_writable ? 'status-active' : 'status-inactive'}"></div>
            <span>Write Access: ${status.device_writable ? 'Available' : 'Not Available'}</span>
        </div>
    `;
}

function showSuccess(message) {
    // Implement toast or alert for success message
    alert(message);
}

function showError(message) {
    // Implement toast or alert for error message
    alert(message);
}
</script>
